{% extends "base.html" %}

{% block head %}
<style>
    .date-nav {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 10px;
    }
    .date-nav .btn {
        margin-right: 5px;
    }
    .recording-list {
        margin-top: 20px;
    }
    .hour-badge {
        min-width: 50px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dropdown navigation -->
<div class="card mb-4 shadow">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-filter me-2"></i>Kies wat je wilt afspelen
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="stationSelect" class="form-label">1. Selecteer station:</label>
                <select id="stationSelect" class="form-select sr-highlight" aria-label="Station selecteren">
                    <option value="all" {% if selected_station == 'all' %}selected{% endif %}>Alle stations</option>
                    <option value="dennis" {% if selected_station == 'dennis' %}selected{% endif %}>Dennis stations</option>
                    <optgroup label="Lokale stations">
                        {% for station in stations %}
                            <option value="{{ station.id }}" {% if selected_station == station.id|string %}selected{% endif %}>
                                {{ station.name }}
                            </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            <div class="col-md-4">
                <label for="dateSelect" class="form-label">2. Selecteer datum:</label>
                <select id="dateSelect" class="form-select sr-highlight" aria-label="Datum selecteren">
                    {% for day in date_nav %}
                        <option value="{{ day.formatted }}" {% if day.date == selected_date %}selected{% endif %}>
                            {{ day.display }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="hourSelect" class="form-label">3. Selecteer uur:</label>
                <select id="hourSelect" class="form-select sr-highlight" aria-label="Uur selecteren" disabled>
                    <option value="">Eerst station en datum selecteren</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3 d-flex justify-content-between">
            <button id="applyFilter" class="btn btn-primary">
                <i class="fas fa-filter me-1"></i>Filter toepassen
            </button>
            
            <div>
                <button id="playButton" class="btn btn-success" disabled>
                    <i class="fas fa-play me-1"></i>Afspelen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Traditional date navigation (for accessibility) -->
<div class="card mb-4 shadow">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-calendar-alt me-2"></i>Navigeer per datum
    </div>
    <div class="card-body">
        <div class="date-nav" role="toolbar" aria-label="Datum navigatie">
            {% for day in date_nav %}
                <a href="{{ url_for('player.list_recordings', date=day.formatted, station=selected_station) }}" 
                   class="btn {% if day.date == selected_date %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                   aria-pressed="{% if day.date == selected_date %}true{% else %}false{% endif %}">
                    {{ day.display }}
                </a>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Recordings list -->
<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-play-circle me-2"></i>Opnames voor {{ selected_date.strftime('%d-%m-%Y') }}
    </div>
    <div class="card-body">
        <!-- Local recordings -->
        {% if recordings %}
            <h5 class="mb-3">Lokale opnames</h5>
            <div class="list-group mb-4">
                {% for recording in recordings %}
                    <a href="{{ url_for('player.player', cloudpath='opnames/' + recording.station.name + '/' + recording.date|string + '/' + recording.hour) }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary hour-badge me-2">{{ recording.hour }}:00</span>
                            <span>{{ recording.station.name }}</span>
                            {% if recording.program_title %}
                                <span class="text-muted ms-2">- {{ recording.program_title }}</span>
                            {% endif %}
                        </div>
                        <span class="badge bg-primary rounded-pill">
                            <i class="fas fa-play"></i>
                        </span>
                    </a>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Dennis recordings -->
        {% if dennis_recordings %}
            <h5 class="mb-3">Dennis' opnames</h5>
            <div class="list-group">
                {% for recording in dennis_recordings %}
                    <a href="{{ url_for('player.player', cloudpath='dennis/' + recording.station.folder + '/' + recording.date|string + '/' + recording.hour) }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary hour-badge me-2">{{ recording.hour }}:00</span>
                            <span>{{ recording.station.name }}</span>
                        </div>
                        <span class="badge bg-primary rounded-pill">
                            <i class="fas fa-play"></i>
                        </span>
                    </a>
                {% endfor %}
            </div>
        {% endif %}

        {% if not recordings and not dennis_recordings %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>Geen opnames gevonden voor deze datum en/of station.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Main elements
        const stationSelect = document.getElementById('stationSelect');
        const dateSelect = document.getElementById('dateSelect');
        const hourSelect = document.getElementById('hourSelect');
        const applyFilterBtn = document.getElementById('applyFilter');
        const playButton = document.getElementById('playButton');
        
        // Recording data structure
        const recordings = {
            // Local recordings
            {% for recording in recordings %}
            "local_{{ recording.station.id }}_{{ recording.date }}_{{ recording.hour }}": {
                stationId: "{{ recording.station.id }}",
                stationName: "{{ recording.station.name }}",
                date: "{{ recording.date }}",
                hour: "{{ recording.hour }}",
                programTitle: "{{ recording.program_title|default('') }}",
                cloudpath: "{{ url_for('player.player', cloudpath='opnames/' + recording.station.name + '/' + recording.date|string + '/' + recording.hour) }}"
            },
            {% endfor %}
            
            // Dennis recordings
            {% for recording in dennis_recordings %}
            "dennis_{{ recording.station.id }}_{{ recording.date }}_{{ recording.hour }}": {
                stationId: "dennis",
                stationName: "{{ recording.station.name }}",
                date: "{{ recording.date }}",
                hour: "{{ recording.hour }}",
                cloudpath: "{{ url_for('player.player', cloudpath='dennis/' + recording.station.folder + '/' + recording.date|string + '/' + recording.hour) }}"
            },
            {% endfor %}
        };
        
        // Apply filter button click
        applyFilterBtn.addEventListener('click', function() {
            const selectedDate = dateSelect.value;
            const selectedStation = stationSelect.value;
            
            window.location.href = "{{ url_for('player.list_recordings') }}?date=" + selectedDate + "&station=" + selectedStation;
        });
        
        // Update hours dropdown when date or station changes
        function updateHoursDropdown() {
            // Clear current options
            hourSelect.innerHTML = '';
            hourSelect.disabled = true;
            playButton.disabled = true;
            
            const selectedStation = stationSelect.value;
            const selectedDate = dateSelect.value;
            
            // If no station or date selected, return
            if (!selectedStation || !selectedDate) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Eerst station en datum selecteren';
                hourSelect.appendChild(option);
                return;
            }
            
            // Find matching recordings
            const hourData = [];
            for (const key in recordings) {
                const rec = recordings[key];
                
                // Check if matches selection
                if ((selectedStation === 'all' || 
                     selectedStation === 'dennis' && rec.stationId === 'dennis' ||
                     selectedStation === rec.stationId) &&
                    rec.date === selectedDate) {
                    
                    hourData.push({
                        hour: rec.hour,
                        display: rec.hour + ':00' + (rec.programTitle ? ' - ' + rec.programTitle : ''),
                        stationName: rec.stationName,
                        cloudpath: rec.cloudpath
                    });
                }
            }
            
            // Sort by hour
            hourData.sort((a, b) => a.hour.localeCompare(b.hour));
            
            // Populate dropdown
            if (hourData.length > 0) {
                hourSelect.disabled = false;
                
                hourData.forEach(hour => {
                    const option = document.createElement('option');
                    option.value = hour.cloudpath;
                    option.textContent = hour.hour + ':00 - ' + hour.stationName;
                    hourSelect.appendChild(option);
                });
                
                playButton.disabled = false;
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Geen opnames beschikbaar';
                hourSelect.appendChild(option);
            }
        }
        
        // Event listeners for dropdowns
        stationSelect.addEventListener('change', updateHoursDropdown);
        dateSelect.addEventListener('change', updateHoursDropdown);
        
        // Play button click handler
        playButton.addEventListener('click', function() {
            if (hourSelect.value) {
                window.location.href = hourSelect.value;
            }
        });
        
        // Allow pressing Enter in the selects to apply filter
        stationSelect.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilterBtn.click();
            }
        });
        
        dateSelect.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilterBtn.click();
            }
        });
        
        hourSelect.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && hourSelect.value) {
                window.location.href = hourSelect.value;
            }
        });
        
        // Initialize hours dropdown
        updateHoursDropdown();
    });
</script>
{% endblock %}
